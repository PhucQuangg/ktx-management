<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="admin/fragments/head::head"></head>

<body class="g-sidenav-show  bg-gray-100">
<div th:replace="admin/fragments/sidebar::sidebar"></div>
<main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
  <!-- Navbar -->
  <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur" data-scroll="true">
    <div class="container-fluid py-1 px-3">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
          <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Trang</a></li>
          <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Danh sách phòng</li>
        </ol>
      </nav>

      <ul class="navbar-nav d-flex align-items-center  justify-content-end">

        <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
          <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
            <div class="sidenav-toggler-inner">
              <i class="sidenav-toggler-line"></i>
              <i class="sidenav-toggler-line"></i>
              <i class="sidenav-toggler-line"></i>
            </div>
          </a>
        </li>
        <li class="nav-item px-3 d-flex align-items-center">
          <a href="javascript:;" class="nav-link text-body p-0">
            <i class="material-symbols-rounded fixed-plugin-button-nav">settings</i>
          </a>
        </li>

        <li class="nav-item d-flex align-items-center">
          <a href="http://localhost:8081/login" class="nav-link text-body font-weight-bold px-0">
            <i class="material-symbols-rounded">account_circle</i>
          </a>
        </li>
      </ul>
    </div>
    </div>
  </nav>
  <!-- End Navbar -->
  <div class="container-fluid py-2">
    <div class="row">
      <div class="col-12">
        <div class="card my-4">
          <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
            <div class="bg-gradient-dark shadow-dark border-radius-lg pt-4 pb-3">
              <h6 class="text-white text-capitalize ps-3">Bảng phòng</h6>
            </div>
          </div>
          <div class="card-body px-0 pb-2">
            <div class="table-responsive p-0">
              <div class="d-flex justify-content-between align-items-center px-4 pt-3">
                <select id="roleFilter" class="form-select w-auto">
                  <option value="ALL">Tất cả</option>
                  <option value="NORMAL">Tiêu chuẩn</option>
                  <option value="PLUS">Tiện nghi</option>
                </select>

                <a th:href="@{/admin/add-room}" class="btn btn-dark" type="button">+ Thêm phòng</a>
              </div>

              <table class="table align-items-center mb-0">
                <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Tên phòng</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Sức chứa</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">SL hiện tại</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Giá</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Tình trạng</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Loại phòng</th>
                  <th class="text-secondary opacity-7"></th>
                </tr>
                </thead>
                <tbody id="roomTableBody">

                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
<script>
  function getToken() {
      return localStorage.getItem("admin_token");
    }

  document.addEventListener("DOMContentLoaded", function() {
    const token = getToken();
    const tbody = document.getElementById("roomTableBody");
    const roleFilter = document.getElementById("roleFilter");
    let allrooms = [];

    fetch("http://localhost:8080/api/admin/rooms", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      }
    })
            .then(async response => {
              if (!response.ok) {
                const err = await response.text();
                showPopup(err, true);
                return ;
              }
              return response.json();
            })
            .then(data => {
              allrooms = data;
              renderTable(allrooms);
            })
            .catch(error => {
              console.error("Lỗi khi tải dữ liệu:", error);
            });

    function renderTable(rooms) {
      tbody.innerHTML = "";
      rooms.forEach(r => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${r.name}</td>
          <td>${r.capacity}</td>
          <td>${r.current_people}</td>
          <td>${r.price}</td>
          <td>${r.status}</td>
          <td>${r.type}</td>
          <td class="text-center">
            <i class="fa-regular fa-pen-to-square text-secondary edit-room" data-id="${r.id}" style="cursor:pointer;"></i>
            <i class="fa-solid fa-trash text-danger delete-room" style="cursor:pointer;" data-id="${r.id}"></i>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.querySelectorAll(".edit-room").forEach(btn => {
        btn.addEventListener("click", function() {
          const roomId = this.getAttribute("data-id");
          window.location.href = `/admin/update-room?id=${roomId}`;
        });
      });

      document.querySelectorAll(".delete-room").forEach(btn => {
        btn.addEventListener("click", function() {
          const roomId = this.getAttribute("data-id");

          showPopup("Bạn có chắc chắn muốn xoá phòng này không?", false, true, async () => {
            try {
              const token = getToken();
              const response = await fetch(`http://localhost:8080/api/admin/rooms/delete/${roomId}`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
              });

              if (response.ok) {
                showPopup("Xoá phòng thành công!");
                setTimeout(() => location.reload(), 1000);
                return true;
              } else {
                  const  err = await response.text();
                  showPopup(err,true);
                  return ;
              }

            } catch (error) {
              console.error(error);
              showPopup("Có lỗi xảy ra khi xoá phòng!", true);
            }
          });
        });
      });
    }

    roleFilter.addEventListener("change", function() {
      const selectedRole = roleFilter.value;
      if (selectedRole === "ALL") {
        renderTable(allrooms);
      } else {
        const filtered = allrooms.filter(r => r.type === selectedRole);
        renderTable(filtered);
      }
    });
  });
</script>


<div th:replace="admin/fragments/showPopup::showPopup"></div>
<div th:replace="admin/fragments/settingUI::UI"></div>
<div th:replace="admin/fragments/script::script"></div>


</body>

</html>