<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thông tin phòng — Quản lý KTX</title>

  <!-- Bootstrap CSS + Icons + Font -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent: #2563eb;
      --accent-2: #f59e0b;
      --card-bg: #ffffff;
      --muted: #64748b;
    }
    body {
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto;
      background: linear-gradient(180deg, #f6f8fb 0%, #eef2f6 100%);
      color: #0f172a;
    }

    .topbar {
      background: linear-gradient(90deg, rgba(37,99,235,0.09), rgba(245,158,11,0.06));
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
    }

    .brand .stu-logo {
      width: 100px;
      height: auto;
      margin-right: 15px;
    }

    .card-modern {
      border: 0;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), var(--card-bg));
      box-shadow: 0 12px 30px rgba(2,6,23,0.08);
    }

    .btn-accent { background: var(--accent); color: #fff; }
    .btn-accent:hover { background: #1e4ed8; }

    .muted { color: var(--muted); font-size: 0.95rem; }
  </style>
</head>

<body>
<div class="container py-5">
  <!-- Header -->
  <div class="topbar mb-4">
    <div class="brand">
      <img th:src="@{/assets/images/small-logos/Logo_STU.png}" alt="STU Logo" class="stu-logo">
      <div>
        <h1 class="fs-3 fw-bold text-primary mb-0">Thông Tin Phòng</h1>
        <p class="muted mb-0">Quản lý ký túc xá — Đại học Công nghệ Sài Gòn</p>
      </div>
    </div>
  </div>

  <!-- Form thêm phòng -->
  <div class="card card-modern p-4">
    <form id="updatedRoomForm">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label"><strong>Tên phòng:</strong></label>
          <input type="text" id="name" name="name" class="form-control" placeholder="Nhập tên phòng" required>
        </div>

        <div class="col-md-6">
          <label class="form-label"><strong>Sức chứa:</strong></label>
          <input type="number" id="capacity" name="capacity" class="form-control" min="1" placeholder="VD: 8" required>
        </div>

        <div class="col-md-6">
          <label class="form-label"><strong>Số người hiện tại:</strong></label>
          <input type="number" id="current_people" name="current_people" class="form-control" value="0" readonly>
        </div>

        <div class="col-md-6">
          <label class="form-label"><strong>Giá phòng (VNĐ):</strong></label>
          <input type="number" id="price" name="price" class="form-control" placeholder="VD: 1200000" required>
        </div>

        <div class="col-md-6">
          <label class="form-label"><strong>Loại phòng:</strong></label>
          <select id="type" name="type" class="form-select" required>
            <option value="">-- Chọn loại phòng --</option>
            <option value="NORMAL">Tiêu chuẩn</option>
            <option value="PLUS">Tiện nghi</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label"><strong>Trạng thái:</strong></label>
          <select id="status" name="status" class="form-select" required>
            <option value="">-- Chọn trạng thái --</option>
            <option value="AVAILABLE">Còn trống</option>
            <option value="FULL">Đầy</option>
            <option value="MAINTENANCE">Bảo trì</option>
          </select>
        </div>
      </div>

      <!-- Buttons -->
      <div class="d-flex justify-content-center gap-3 mt-4">
        <button type="button" id="backBtn" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Trở về</button>
        <button type="button" id="updateBtn" class="btn btn-warning fw-bold"> Cập nhật </button>
        <button type="button" id="saveBtn" class="btn btn-success d-none"> Lưu</button>
        <button type="button" id="cancelBtn" class="btn btn-outline-secondary d-none">Hủy</button>
      </div>
    </form>
  </div>
</div>
<div th:replace="admin/fragments/showPopup::showPopup"></div>
<div th:replace="admin/fragments/script::script"></div>


<script>
  document.addEventListener("DOMContentLoaded", function() {
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get("id");
    if (!roomId) {
      showPopup("Không tìm thấy ID phòng!", true);
      return;
    }

    loadInformation(roomId);

    // Xử lý nút cập nhật
    document.getElementById("updateBtn").addEventListener("click", function() {
      document.querySelectorAll("#updatedRoomForm input, #updatedRoomForm select").forEach(el => {
        if (el.id !== "current_people") {
          el.removeAttribute("readonly");
          el.removeAttribute("disabled");
        }
      });
      toggleButtons(true);
    });

    // Xử lý nút hủy
    document.getElementById("cancelBtn").addEventListener("click", function() {
      document.querySelectorAll("#updatedRoomForm input, #updatedRoomForm select").forEach(el => {
        el.setAttribute("readonly", true);
        el.setAttribute("disabled", true);
      });
      toggleButtons(false);
      loadInformation(roomId);
    });

    // Xử lý nút lưu
    document.getElementById("saveBtn").addEventListener("click", async function() {
      const token = localStorage.getItem("admin_token");
      const roomData = {
        name: document.getElementById("name").value.trim(),
        capacity: document.getElementById("capacity").value,
        price: document.getElementById("price").value,
        type: document.getElementById("type").value,
        status: document.getElementById("status").value
      };

      if (!roomData.name || !roomData.capacity || !roomData.price || !roomData.type || !roomData.status) {
        showPopup("❌ Vui lòng nhập đầy đủ thông tin!", true);
        return;
      }

      try {
        const response = await fetch(`http://localhost:8080/api/admin/rooms/update/${roomId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token,
          },
          body: JSON.stringify(roomData)
        });

        if (!response.ok){
          const  err = await response.text();
          showPopup(err,true);
          return;
        }

        showPopup("✅ Cập nhật phòng thành công!");
        toggleButtons(false);

        document.querySelectorAll("#updatedRoomForm input, #updatedRoomForm select").forEach(el => {
          el.setAttribute("readonly", true);
          el.setAttribute("disabled", true);
        });

      } catch (error) {
        console.error(error);
        showPopup("❌ Lỗi khi cập nhật thông tin phòng!", true);
      }
    });

    // Nút trở về
    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "http://localhost:8082/admin/rooms";
    });
  });

  async function loadInformation(roomId) {
    const token = localStorage.getItem("admin_token");
    try {
      const response = await fetch(`http://localhost:8080/api/admin/rooms/edit/${roomId}`, {
        method: "GET",
        headers: { "Authorization": "Bearer " + token }
      });

      if (!response.ok){
        const  err = await response.text();
        showPopup(err,true);
        return;
      }
      const data = await response.json();

      document.getElementById("name").value = data.name || "";
      document.getElementById("capacity").value = data.capacity;
      document.getElementById("current_people").value = data.current_people;
      document.getElementById("price").value = data.price;
      document.getElementById("type").value = data.type;
      document.getElementById("status").value = data.status;

      // Tất cả input ban đầu readonly
      document.querySelectorAll("#updatedRoomForm input, #updatedRoomForm select").forEach(el => {
        el.setAttribute("readonly", true);
        el.setAttribute("disabled", true);
      });

    } catch (error) {
      console.error(error);
      showPopup("❌ Lỗi khi tải thông tin phòng!", true);
    }
  }

  function toggleButtons(editMode) {
    document.getElementById("updateBtn").classList.toggle("d-none", editMode);
    document.getElementById("saveBtn").classList.toggle("d-none", !editMode);
    document.getElementById("cancelBtn").classList.toggle("d-none", !editMode);
    document.getElementById("backBtn").classList.toggle("d-none", editMode);
  }
</script>


</body>
</html>
