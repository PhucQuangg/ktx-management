<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th√¥ng tin c√° nh√¢n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="text-center mb-4">Th√¥ng tin c√° nh√¢n sinh vi√™n</h2>

  <div id="profile" class="card p-4 shadow-sm">
    <div class="mb-3">
      <label class="form-label"><strong>H·ªç v√† t√™n:</strong></label>
      <input type="text" id="fullName" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Email:</strong></label>
      <input type="email" id="email" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Gi·ªõi t√≠nh:</strong></label>
      <select id="gender" class="form-select" disabled>
        <option value="true">N·ªØ</option>
        <option value="false">Nam</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Ng√†y sinh:</strong></label>
      <input type="date" id="dob" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>S·ªë ƒëi·ªán tho·∫°i:</strong></label>
      <input type="text" id="phone" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>L·ªõp:</strong></label>
      <input type="text" id="className" class="form-control" readonly>
    </div>

    <!-- N√∫t ƒë·ªïi m·∫≠t kh·∫©u t√°ch ri√™ng -->
    <div class="text-center mt-3">
      <button id="updateBtn" class="btn btn-primary">C·∫≠p nh·∫≠t th√¥ng tin</button>
      <button id="saveBtn" class="btn btn-success d-none">L∆∞u</button>
      <button id="cancelBtn" class="btn btn-secondary d-none">H·ªßy</button>
      <button id="changePasswordBtn" class="btn btn-warning">ƒê·ªïi m·∫≠t kh·∫©u</button>
    </div>
  </div>

  <!-- Khu v·ª±c ƒë·ªïi m·∫≠t kh·∫©u -->
  <div id="passwordChangeSection" class="card p-4 shadow-sm mt-4" style="display:none;">
    <h5 class="text-primary mb-3">ƒê·ªïi m·∫≠t kh·∫©u</h5>

    <div class="mb-3">
      <label>M·∫≠t kh·∫©u hi·ªán t·∫°i:</label>
      <input type="password" id="oldPassword" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i">
    </div>

    <div class="mb-3">
      <label>M·∫≠t kh·∫©u m·ªõi:</label>
      <input type="password" id="newPassword" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi">
    </div>

    <div class="mb-3">
      <label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi:</label>
      <input type="password" id="confirmPassword" class="form-control" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
    </div>

    <button id="toggleShowPassword" class="btn btn-outline-secondary btn-sm mb-3">Hi·ªán m·∫≠t kh·∫©u</button>

    <div class="text-center">
      <button id="savePasswordBtn" class="btn btn-success">X√°c nh·∫≠n ƒë·ªïi</button>
      <button id="cancelPasswordBtn" class="btn btn-secondary">H·ªßy</button>
    </div>
  </div>
</div><!-- Popup th√¥ng b√°o -->
<div id="popupOverlay"
     style="
       display:none;
       position:fixed;
       top:0; left:0;
       width:100%; height:100%;
       background:rgba(0,0,0,0.5);
       z-index:2000;
       justify-content:center;
       align-items:center;">
  <div id="popupBox"
       style="
         background:#fff;
         border-radius:10px;
         width:350px;
         max-width:90%;
         padding:20px 25px;
         box-shadow:0 4px 10px rgba(0,0,0,0.3);
         text-align:center;
         transform:scale(0.8);
         opacity:0;
         transition:all 0.3s ease;">
    <h5 id="popupTitle" style="font-weight:600;">Th√¥ng b√°o</h5>
    <p id="popupMessage" style="margin-top:10px; color:#333;"></p>
    <button id="popupCloseBtn">ƒê√≥ng</button>
  </div>
</div>


<script>
  function showPopup(message, isError = false) {
    const overlay = document.getElementById("popupOverlay");
    const box = document.getElementById("popupBox");
    const msg = document.getElementById("popupMessage");
    const title = document.getElementById("popupTitle");
    const closeBtn = document.getElementById("popupCloseBtn");

    msg.textContent = message;
    title.textContent = isError ? "L·ªói" : "Th√¥ng b√°o";
    title.style.color = isError ? "#dc3545" : "#198754";
    closeBtn.className = isError ? "btn btn-danger mt-2" : "btn btn-success mt-2";

    // Hi·ªán overlay v√† hi·ªáu ·ª©ng b·∫≠t
    overlay.style.display = "flex";
    setTimeout(() => {
      box.style.opacity = "1";
      box.style.transform = "scale(1)";
    }, 50);

    // ƒê√≥ng khi b·∫•m n√∫t
    closeBtn.onclick = () => {
      box.style.opacity = "0";
      box.style.transform = "scale(0.8)";
      setTimeout(() => (overlay.style.display = "none"), 300);
    };
  }

  function getToken() {
    return localStorage.getItem("token");
  }

  // --- T·∫¢I TH√îNG TIN C√Å NH√ÇN ---
  async function loadProfile() {
    const token = getToken();
    if (!token) {
      alert("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
      window.location.href = "/login.html";
      return;
    }

    try {
      const response = await fetch("http://localhost:8080/api/student/profile", {
        method: "GET",
        headers: {
          "Authorization": "Bearer " + token,
        }
      });

      if (!response.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin sinh vi√™n");

      const data = await response.json();
      document.getElementById("fullName").value = data.fullName || "";
      document.getElementById("email").value = data.email || "";
      document.getElementById("gender").value = data.gender === null ? "" : data.gender.toString();
      document.getElementById("dob").value = data.dateOfBirth || "";
      document.getElementById("phone").value = data.phone || "";
      document.getElementById("className").value = data.className || "";
    } catch (error) {
      console.error(error);
      showPopup("‚ùå L·ªói khi t·∫£i th√¥ng tin c√° nh√¢n!",true);
    }
  }

  // --- C·∫¨P NH·∫¨T TH√îNG TIN ---
  document.getElementById("updateBtn").addEventListener("click", () => {
    document.querySelectorAll("#profile input, #profile select").forEach(el => {
      if (el.id !== "password") {
        el.removeAttribute("readonly");
        el.removeAttribute("disabled");
      }
    });
    document.getElementById("updateBtn").classList.add("d-none");
    document.getElementById("saveBtn").classList.remove("d-none");
    document.getElementById("cancelBtn").classList.remove("d-none");
    document.getElementById("changePasswordBtn").classList.add("d-none");
  });

  document.getElementById("cancelBtn").addEventListener("click", () => {
    document.querySelectorAll("#profile input, #profile select").forEach(el => {
      el.setAttribute("readonly", true);
      el.setAttribute("disabled", true);
    });
    document.getElementById("updateBtn").classList.remove("d-none");
    document.getElementById("saveBtn").classList.add("d-none");
    document.getElementById("cancelBtn").classList.add("d-none");
    document.getElementById("changePasswordBtn").classList.remove("d-none");
    loadProfile();
  });

  document.getElementById("saveBtn").addEventListener("click", async () => {
    const token = getToken();

    const fullName = document.getElementById("fullName").value.trim();
    const email = document.getElementById("email").value.trim();
    const gender = document.getElementById("gender").value;
    const dateOfBirth = document.getElementById("dob").value;
    const phone = document.getElementById("phone").value.trim();
    const className = document.getElementById("className").value.trim();

    if (!fullName || !email || !dateOfBirth || !phone || !className || gender === "") {
      showPopup("‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng th√¥ng tin!", true);
      return;
    }
    const updatedData = {
      fullName: fullName,
      email: email,
      gender: gender === "true",
      dateOfBirth: dateOfBirth,
      phone: phone,
      className: className,
    };

    try {
      const response = await fetch("http://localhost:8080/api/student/profile/update", {
        method: "PUT",
      headers: {
          "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
        body: JSON.stringify(updatedData)
      });

      if (!response.ok) throw new Error("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin");
      showPopup("‚úÖ C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!");

      setTimeout(() => {
        window.location.reload();
      }, 3000);
    } catch (error) {
      console.error(error);
      showPopup("‚ùå L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin!", true);

    }
  });

  // --- X·ª¨ L√ù ƒê·ªîI M·∫¨T KH·∫®U ---
  document.getElementById("changePasswordBtn").addEventListener("click", () => {
    document.getElementById("passwordChangeSection").style.display = "block";
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  });

  document.getElementById("cancelPasswordBtn").addEventListener("click", () => {
    document.getElementById("passwordChangeSection").style.display = "none";
    document.getElementById("oldPassword").value = "";
    document.getElementById("newPassword").value = "";
    document.getElementById("confirmPassword").value = "";
  });

  document.getElementById("toggleShowPassword").addEventListener("click", () => {
    ["oldPassword", "newPassword", "confirmPassword"].forEach(id => {
      const field = document.getElementById(id);
      field.type = field.type === "password" ? "text" : "password";
    });
  });

  document.getElementById("savePasswordBtn").addEventListener("click", async () => {
    const oldPass = document.getElementById("oldPassword").value.trim();
    const newPass = document.getElementById("newPassword").value.trim();
    const confirmPass = document.getElementById("confirmPassword").value.trim();
    const token = getToken();

    if (!oldPass || !newPass || !confirmPass) {
      showPopup("‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng!",true);
      return;
    }
    if (newPass !== confirmPass) {
      showPopup(" ‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!",true);
      return;
    }

    try {
      const response = await fetch("http://localhost:8080/api/student/change-password", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
          oldPassword: oldPass,
          newPassword: newPass
        })
      });

      if (!response.ok) throw new Error("Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u");
      showPopup("üîí ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!");

      document.getElementById("passwordChangeSection").style.display = "none";
      document.getElementById("oldPassword").value = "";
      document.getElementById("newPassword").value = "";
      document.getElementById("confirmPassword").value = "";
    } catch (error) {
      console.error(error);
      showPopup("‚ùå L·ªói khi ƒë·ªïi m·∫≠t kh·∫©u!", true);
    }
  });

  window.onload = loadProfile;
</script>
</body>
</html>
