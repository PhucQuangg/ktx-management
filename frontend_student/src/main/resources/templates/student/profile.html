<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thông tin cá nhân</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="text-center mb-4">Thông tin cá nhân sinh viên</h2>

  <div id="profile" class="card p-4 shadow-sm">
    <div class="mb-3">
      <label class="form-label"><strong>Họ và tên:</strong></label>
      <input type="text" id="fullName" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Email:</strong></label>
      <input type="email" id="email" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Giới tính:</strong></label>
      <select id="gender" class="form-select" disabled>
        <option value="true">Nữ</option>
        <option value="false">Nam</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Ngày sinh:</strong></label>
      <input type="date" id="dob" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Số điện thoại:</strong></label>
      <input type="text" id="phone" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Lớp:</strong></label>
      <input type="text" id="className" class="form-control" readonly>
    </div>

    <!-- Nút đổi mật khẩu tách riêng -->
    <div class="text-center mt-3">
      <button id="updateBtn" class="btn btn-primary">Cập nhật thông tin</button>
      <button id="saveBtn" class="btn btn-success d-none">Lưu</button>
      <button id="cancelBtn" class="btn btn-secondary d-none">Hủy</button>
      <button id="changePasswordBtn" class="btn btn-warning">Đổi mật khẩu</button>
    </div>
  </div>

  <!-- Khu vực đổi mật khẩu -->
  <div id="passwordChangeSection" class="card p-4 shadow-sm mt-4" style="display:none;">
    <h5 class="text-primary mb-3">Đổi mật khẩu</h5>

    <div class="mb-3">
      <label>Mật khẩu hiện tại:</label>
      <input type="password" id="oldPassword" class="form-control" placeholder="Nhập mật khẩu hiện tại">
    </div>

    <div class="mb-3">
      <label>Mật khẩu mới:</label>
      <input type="password" id="newPassword" class="form-control" placeholder="Nhập mật khẩu mới">
    </div>

    <div class="mb-3">
      <label>Xác nhận mật khẩu mới:</label>
      <input type="password" id="confirmPassword" class="form-control" placeholder="Nhập lại mật khẩu mới">
    </div>

    <button id="toggleShowPassword" class="btn btn-outline-secondary btn-sm mb-3">Hiện mật khẩu</button>

    <div class="text-center">
      <button id="savePasswordBtn" class="btn btn-success">Xác nhận đổi</button>
      <button id="cancelPasswordBtn" class="btn btn-secondary">Hủy</button>
    </div>
  </div>
</div><!-- Popup thông báo -->
<div id="popupOverlay"
     style="
       display:none;
       position:fixed;
       top:0; left:0;
       width:100%; height:100%;
       background:rgba(0,0,0,0.5);
       z-index:2000;
       justify-content:center;
       align-items:center;">
  <div id="popupBox"
       style="
         background:#fff;
         border-radius:10px;
         width:350px;
         max-width:90%;
         padding:20px 25px;
         box-shadow:0 4px 10px rgba(0,0,0,0.3);
         text-align:center;
         transform:scale(0.8);
         opacity:0;
         transition:all 0.3s ease;">
    <h5 id="popupTitle" style="font-weight:600;">Thông báo</h5>
    <p id="popupMessage" style="margin-top:10px; color:#333;"></p>
    <button id="popupCloseBtn">Đóng</button>
  </div>
</div>


<script>
  function showPopup(message, isError = false) {
    const overlay = document.getElementById("popupOverlay");
    const box = document.getElementById("popupBox");
    const msg = document.getElementById("popupMessage");
    const title = document.getElementById("popupTitle");
    const closeBtn = document.getElementById("popupCloseBtn");

    msg.textContent = message;
    title.textContent = isError ? "Lỗi" : "Thông báo";
    title.style.color = isError ? "#dc3545" : "#198754";
    closeBtn.className = isError ? "btn btn-danger mt-2" : "btn btn-success mt-2";

    // Hiện overlay và hiệu ứng bật
    overlay.style.display = "flex";
    setTimeout(() => {
      box.style.opacity = "1";
      box.style.transform = "scale(1)";
    }, 50);

    // Đóng khi bấm nút
    closeBtn.onclick = () => {
      box.style.opacity = "0";
      box.style.transform = "scale(0.8)";
      setTimeout(() => (overlay.style.display = "none"), 300);
    };
  }

  function getToken() {
    return localStorage.getItem("token");
  }

  // --- TẢI THÔNG TIN CÁ NHÂN ---
  async function loadProfile() {
    const token = getToken();
    if (!token) {
      alert("Vui lòng đăng nhập lại!");
      window.location.href = "/login.html";
      return;
    }

    try {
      const response = await fetch("http://localhost:8080/api/student/profile", {
        method: "GET",
        headers: {
          "Authorization": "Bearer " + token,
        }
      });

      if (!response.ok) throw new Error("Không thể tải thông tin sinh viên");

      const data = await response.json();
      document.getElementById("fullName").value = data.fullName || "";
      document.getElementById("email").value = data.email || "";
      document.getElementById("gender").value = data.gender === null ? "" : data.gender.toString();
      document.getElementById("dob").value = data.dateOfBirth || "";
      document.getElementById("phone").value = data.phone || "";
      document.getElementById("className").value = data.className || "";
    } catch (error) {
      console.error(error);
      showPopup("❌ Lỗi khi tải thông tin cá nhân!",true);
    }
  }

  // --- CẬP NHẬT THÔNG TIN ---
  document.getElementById("updateBtn").addEventListener("click", () => {
    document.querySelectorAll("#profile input, #profile select").forEach(el => {
      if (el.id !== "password") {
        el.removeAttribute("readonly");
        el.removeAttribute("disabled");
      }
    });
    document.getElementById("updateBtn").classList.add("d-none");
    document.getElementById("saveBtn").classList.remove("d-none");
    document.getElementById("cancelBtn").classList.remove("d-none");
    document.getElementById("changePasswordBtn").classList.add("d-none");
  });

  document.getElementById("cancelBtn").addEventListener("click", () => {
    document.querySelectorAll("#profile input, #profile select").forEach(el => {
      el.setAttribute("readonly", true);
      el.setAttribute("disabled", true);
    });
    document.getElementById("updateBtn").classList.remove("d-none");
    document.getElementById("saveBtn").classList.add("d-none");
    document.getElementById("cancelBtn").classList.add("d-none");
    document.getElementById("changePasswordBtn").classList.remove("d-none");
    loadProfile();
  });

  document.getElementById("saveBtn").addEventListener("click", async () => {
    const token = getToken();

    const fullName = document.getElementById("fullName").value.trim();
    const email = document.getElementById("email").value.trim();
    const gender = document.getElementById("gender").value;
    const dateOfBirth = document.getElementById("dob").value;
    const phone = document.getElementById("phone").value.trim();
    const className = document.getElementById("className").value.trim();

    if (!fullName || !email || !dateOfBirth || !phone || !className || gender === "") {
      showPopup("❌ Vui lòng nhập đầy đủ các trường thông tin!", true);
      return;
    }
    const updatedData = {
      fullName: fullName,
      email: email,
      gender: gender === "true",
      dateOfBirth: dateOfBirth,
      phone: phone,
      className: className,
    };

    try {
      const response = await fetch("http://localhost:8080/api/student/profile/update", {
        method: "PUT",
      headers: {
          "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
        body: JSON.stringify(updatedData)
      });

      if (!response.ok) throw new Error("Không thể cập nhật thông tin");
      showPopup("✅ Cập nhật thông tin thành công!");

      setTimeout(() => {
        window.location.reload();
      }, 3000);
    } catch (error) {
      console.error(error);
      showPopup("❌ Lỗi khi cập nhật thông tin!", true);

    }
  });

  // --- XỬ LÝ ĐỔI MẬT KHẨU ---
  document.getElementById("changePasswordBtn").addEventListener("click", () => {
    document.getElementById("passwordChangeSection").style.display = "block";
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  });

  document.getElementById("cancelPasswordBtn").addEventListener("click", () => {
    document.getElementById("passwordChangeSection").style.display = "none";
    document.getElementById("oldPassword").value = "";
    document.getElementById("newPassword").value = "";
    document.getElementById("confirmPassword").value = "";
  });

  document.getElementById("toggleShowPassword").addEventListener("click", () => {
    ["oldPassword", "newPassword", "confirmPassword"].forEach(id => {
      const field = document.getElementById(id);
      field.type = field.type === "password" ? "text" : "password";
    });
  });

  document.getElementById("savePasswordBtn").addEventListener("click", async () => {
    const oldPass = document.getElementById("oldPassword").value.trim();
    const newPass = document.getElementById("newPassword").value.trim();
    const confirmPass = document.getElementById("confirmPassword").value.trim();
    const token = getToken();

    if (!oldPass || !newPass || !confirmPass) {
      showPopup("❌ Vui lòng nhập đầy đủ các trường!",true);
      return;
    }
    if (newPass !== confirmPass) {
      showPopup(" ❌ Mật khẩu xác nhận không khớp!",true);
      return;
    }

    try {
      const response = await fetch("http://localhost:8080/api/student/change-password", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
          oldPassword: oldPass,
          newPassword: newPass
        })
      });

      if (!response.ok) throw new Error("Không thể đổi mật khẩu");
      showPopup("🔒 Đổi mật khẩu thành công!");

      document.getElementById("passwordChangeSection").style.display = "none";
      document.getElementById("oldPassword").value = "";
      document.getElementById("newPassword").value = "";
      document.getElementById("confirmPassword").value = "";
    } catch (error) {
      console.error(error);
      showPopup("❌ Lỗi khi đổi mật khẩu!", true);
    }
  });

  window.onload = loadProfile;
</script>
</body>
</html>
