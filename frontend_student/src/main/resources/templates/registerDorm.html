<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head::head"></head>
<body class="hold-transition skin-blue sidebar-mini">

<div class="wrapper">
  <div th:replace="fragments/header::header"></div>
  <div th:replace="fragments/sidebar::sidebar"></div>

  <div class="content-wrapper">
    <div class="container mt-5 mb-5 p-4 shadow rounded bg-white">
      <h3 class="text-center mb-4">Biểu mẫu đăng ký nội trú ký túc xá</h3>

      <form id="dangkynoitruForm">

        <div class="row mb-3">
          <div class="col">
            <label for="fullName" class="form-label">Họ và tên</label>
            <input type="text" class="form-control" id="fullName"  >
          </div>
          <div class="col">
            <label for="username" class="form-label">Mã sinh viên (MSSV)</label>
            <input type="text" class="form-control" id="username"  >
          </div>
        </div>

        <div class="row mb-3">
          <div class="col">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email"  >
          </div>
          <div class="col">
            <label for="phone" class="form-label">Số điện thoại</label>
            <input type="text" class="form-control" id="phone"  >
          </div>
        </div>

        <div class="row mb-3">
          <div class="col">
            <label for="dateOfBirth" class="form-label">Ngày sinh</label>
            <input type="date" class="form-control" id="dateOfBirth">
          </div>
          <div class="col">
            <label class="form-label d-block">Giới tính</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="gender" id="genderNam" value="false" checked>
              <label class="form-check-label" for="genderNam">Nam</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="gender" id="genderNu" value="true">
              <label class="form-check-label" for="genderNu">Nữ</label>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col">
            <label for="className" class="form-label">Lớp</label>
            <input type="text" class="form-control" id="className">
          </div>
        </div>


        <button type="submit" class="btn btn-primary w-100">Gửi đăng ký</button>

        <div id="message" class="mt-3 text-center"></div>
      </form>
    </div>


  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const token = sessionStorage.getItem("token");
    const form = document.getElementById("dangkynoitruForm");
    const messageDiv = document.getElementById("message");

    if (token) {
      form.querySelectorAll("input, button").forEach(el => el.disabled = true);
      messageDiv.innerHTML = `<p class="text-info fw-bold">
        Không thể đăng ký nội trú mới khi tài khoản đã tồn tại.
      </p>`;
      return;
    }
  });
  document.getElementById("dangkynoitruForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const messageDiv = document.getElementById("message");
    messageDiv.innerHTML = "";

    const fullName = document.getElementById("fullName").value.trim();
    const username = document.getElementById("username").value.trim();
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const className = document.getElementById("className").value.trim();
    const gender = document.querySelector('input[name="gender"]:checked').value === "true";
    const dateOfBirth = document.getElementById("dateOfBirth").value;

    if (!fullName || !username || !email || !phone || !className || !dateOfBirth) {
      messageDiv.innerHTML = `<p class="text-danger fw-bold">Vui lòng nhập đầy đủ tất cả các trường!</p>`;
      return;
    }
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if (!emailRegex.test(email)) {
      messageDiv.innerHTML = `<p class="text-danger fw-bold">Email không hợp lệ! Vui lòng nhập đúng định dạng (ví dụ: ten@gmail.com).</p>`;
      return;
    }

    const data = {
      username,
      fullName,
      email,
      phone,
      className,
      gender,
      dateOfBirth,
      password: "12345678",
      role: "STUDENT"
    };

    try {
      const response = await fetch("http://localhost:8080/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        messageDiv.innerHTML = `<p class="text-success fw-bold">Đăng ký thành công! Vui lòng chờ admin duyệt và gửi thông báo qua email.</p>`;
        document.getElementById("dangkynoitruForm").reset();
      } else {
        const err = await response.text();
        messageDiv.innerHTML = `<p class="text-danger fw-bold">${err}</p>`;
      }
    } catch (error) {
      messageDiv.innerHTML = `<p class="text-danger fw-bold">Không thể kết nối đến máy chủ! Vui lòng thử lại sau.</p>`;
    }
  });
</script>

<div th:replace="fragments/script::script"></div>

</body>
</html>
