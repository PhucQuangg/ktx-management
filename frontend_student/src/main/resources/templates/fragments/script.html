<div th:fragment="script">
    <script th:src="@{/assets/js/jquery.min.js}"></script>
    <script th:src="@{/assets/js/jquery-ui.js}"></script>
    <script th:src="@{/assets/js/bootstrap.min.js}"></script>
    <script th:src="@{/assets/js/adminlte.min.js}"></script>
    <script th:src="@{/assets/js/dashboard.js}"></script>
    <script th:src="@{/assets/js/function.js}"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function parseJwt(token) {
                try {
                    return JSON.parse(atob(token.split('.')[1]));
                } catch (e) {
                    return null;
                }
            }

            const token = sessionStorage.getItem("token");
            if (token) {
                const decoded = parseJwt(token);
                if (decoded && decoded.username) {
                    const elements = document.querySelectorAll(".usernameSpan");
                    elements.forEach(el => {
                        el.innerText = decoded.username;
                    });
                }
            }
        });

        function logout() {
            fetch("http://localhost:8080/api/auth/logout", {
                method: "POST",
            })
                .then(response => {
                    if (response.ok) {
                        sessionStorage.clear();
                        window.location.href = "http://localhost:8081/login";
                    } else {
                        alert("Logout failed: " + response.status);
                    }
                })
                .catch(() => alert("Không thể kết nối tới server!"));
        }


        const userMenu = document.getElementById("userMenu");
        const token = sessionStorage.getItem("token");

        if (token) {
            userMenu.innerHTML = `
            <div class="pull-left">
                <a href="/profile" class="btn btn-default btn-flat">Profile</a>
            </div>
            <div class="pull-right">
                <a onclick="logout()" class="btn btn-default btn-flat">Sign out</a>
            </div>
        `;
        } else {
            userMenu.innerHTML = `
            <div class="text-center" style="width:100%">
                <a href="/login" class="btn btn-default btn-flat">Sign in</a>
            </div>
        `;
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            const fromLogin = params.get("fromLogin");
            const role = params.get("role");

            if (fromLogin && role === "STUDENT") {
                window.history.replaceState({}, document.title, window.location.pathname);
                location.reload();
            }
        });
    </script>

    <script>
        function showPopup(message, isError = false) {
            const overlay = document.getElementById("popupOverlay");
            const box = document.getElementById("popupBox");
            const msg = document.getElementById("popupMessage");
            const title = document.getElementById("popupTitle");
            const closeBtn = document.getElementById("popupCloseBtn");

            msg.textContent = message;
            title.textContent = isError ? "Lỗi" : "Thông báo";
            title.style.color = isError ? "#dc3545" : "#198754";
            closeBtn.className = isError ? "btn btn-danger mt-2" : "btn btn-success mt-2";

            // Hiện overlay và hiệu ứng bật
            overlay.style.display = "flex";
            setTimeout(() => {
                box.style.opacity = "1";
                box.style.transform = "scale(1)";
            }, 50);

            // Đóng khi bấm nút
            closeBtn.onclick = () => {
                box.style.opacity = "0";
                box.style.transform = "scale(0.8)";
                setTimeout(() => (overlay.style.display = "none"), 300);
            };
        }
    </script>
</div>